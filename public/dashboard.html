<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dash.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="shortcut icon" href="./assets/icones/favIcon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>O Rappa | Dashboard</title>
</head>

<body onload="buscarSexo(), listar()">
    <main>
        <nav class="main-menu">
            <img class="logo" src="./assets/imgs/ORaioRappa.png" />
            <ul>
                <li class="nav-item active">
                    <b></b>
                    <b></b>
                    <a href="./dashboard.html">
                        <i class="fa fa-house nav-icon"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>

                <li class="nav-item">
                    <b></b>
                    <b></b>
                    <a href="./quiz.html">
                        <i class="fa fa-user nav-icon"></i>
                        <span class="nav-text">Quiz</span>
                    </a>
                </li>

                <li class="nav-item">
                    <b></b>
                    <b></b>
                    <a href="./formulario.html">
                        <i class="fa fa-calendar-check nav-icon"></i>
                        <span class="nav-text">Formulário</span>
                    </a>
                </li>
                <li class="nav-item">
                    <b></b>
                    <b></b>
                    <a href="./index.html">
                        <i class="fa fa-sliders nav-icon"></i>
                        <span class="nav-text">Sair</span>
                    </a>
                </li>

                <li class="nav-item">
                    <b></b>
                    <b></b>
                    <a href="#">
                        <i class="fa fa-sliders nav-icon"></i>
                        <span class="nav-text">Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <section class="content">
            <div class="left-content">
                <div class="left-bottom">
                    <div class="personal-bests">
                        <div class="personal-bests-container">
                            <div class="best-item box-one">
                                <p>Longest Distance Cycling: </p>
                                <img
                                    src="https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/a3b3cb3a-5127-498b-91cc-a1d39499164a" />
                            </div>
                            <div class="best-item box-two">
                                <p>Longest Roller-Skating: </p>
                                <img
                                    src="https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/e0ee8ffb-faa8-462a-b44d-0a18c1d9604c" />
                            </div>
                            <div class="best-item box-three">
                                <p>Longest Roller-Skating: </p>
                                <img
                                    src="https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/e0ee8ffb-faa8-462a-b44d-0a18c1d9604c" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="activities">
                    <h1>Gráficos</h1>
                    <div class="activity-container">
                        <div class="box1">
                            <div class="chart-container">
                                <canvas id="myChart2"></canvas>
                            </div>
                        </div>

                        <div class="image-container img-four">
                            <div class="box2">
                                <div class="chart-container2">
                                    <canvas id="myChart"></canvas>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="right-content">
                <div class="tabelaRanking"><!-- Define uma tabela -->
                    <div id="tabelaRanking" class="tabela">

                        <div class="cabecalho">
                            <div class="cabecalho-item">Posição</div>
                            <div class="cabecalho-item">Usuário</div>
                            <div class="cabecalho-item">Tutorial Finalizado</div>

                        </div>
                        <!--Para barra de rolagem-->
                        <div class="corpo-scroll">
                            <div id="corpoTabela" class="corpo"></div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </section>
    </main>
</body>

<script>
    let graficoAlbuns;
    let graficoSexo;

    function buscarAlbuns() {
        fetch("/formulario/receberAlbuns", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar trazer o resultado");
                }
            })
            .then(function (data) {
                if (data.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }

                atualizarGraficoAlbuns(data);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
            });
    }

    function atualizarGraficoAlbuns(dados) {
        console.log("Dados recebidos para o gráfico dos albuns:", dados);

        const ctx = document.getElementById('myChart2').getContext('2d');

        if (graficoAlbuns) {
            graficoAlbuns.destroy();
        }
        // Extrair os votos dos dados recebidos e converter para números inteiros
        const votosAlbuns = dados.map(item => item.qtdVotos); // Extraímos apenas os votos
        const nomesAlbuns = ['O Rappa', 'Rappa Mundi', 'Lado B Lado A', 'O Silêncio Q Precede o Esporro', '7 Vezes', 'Nunca Tem Fim...', 'Nao Possui'];
        let qtdVotos = 0;
        let nomeVotado = nomesAlbuns[0];

        // CALCULA QUAL FOI A FAIXA MAIS VOTADA
        for (let i = 0; i < votosAlbuns.length; i++) {
            if (votosAlbuns[i] > qtdVotos) {
                qtdVotos = votosAlbuns[i];
                nomeVotado = nomesAlbuns[i]
            }
        }



        graficoAlbuns = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: nomesAlbuns,
                datasets: [{
                    label: 'Votos dos usuários',
                    data: votosAlbuns,
                    borderColor: 'transparent',
                    backgroundColor: '#1B1A1A',
                }]
            },
            options: {
                animation: false,
                scales: {
                    x: {
                        beginAtZero: true,
                    },
                    y: {
                        beginAtZero: true,
                    }
                },
                animation: {
                    duration: 0
                },
            }
        });

        // EXIBE A FAIXA E OS VOTOS
        // TAG.innerHTML = nomeVotado;
        // TAG.innerHTML = `${qtdVotados} Votos`;
    }

    buscarAlbuns();
    setInterval(buscarAlbuns, 5000);


    function buscarSexo() {
        fetch("/formulario/receberForm", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar trazer o resultado");
                }
            })
            .then(function (data) {
                if (data.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }
                atualizarGraficoSexo(data)
            })
            .catch(function (erro) {
                console.log(`#ERRO: ${erro}`);
            });
    }



    function atualizarGraficoSexo(dados) {
        const ctx = document.getElementById('myChart').getContext('2d');

        if (graficoSexo) {
            graficoSexo.destroy();
        }

        // Extrai as quantidades do objeto de resultados
        let quantidades = dados.map(item => item.quantidade);

        graficoSexo = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Feminino', 'Masculino'],
                datasets: [{
                    label: 'Gênero',
                    backgroundColor: ['#1B1A1A', '#A7877A'],
                    data: quantidades,
                    borderWidth: 1
                }]
            },
            options: {
                animation: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    buscarSexo()
    setInterval(buscarSexo, 5000)

    /* Função de ranking*/
    const ranking = [];
    function listar() {
        fetch("/medidas/ranking", {
            method: "GET",
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error('Erro ao recuperar o ranking');
                }
                return resposta.json();
            })
            .then((ranking) => {
                console.log('Dados do ranking recebidos com sucesso:', ranking);
                preencherRanking(ranking);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro.message}`);
            });
    }
    function preencherRanking(ranking) {
        //reordena do maior para o menor (sort() = ornagina os elementos do arraw conforme a função dada)
        ranking.sort((a, b) => b.pontuacao - a.pontuacao);

        const corpoTabela = document.getElementById('corpoTabela');
        corpoTabela.innerHTML = '';

        //forEach() é usado para iterar sobre cada entrada no ranking ordenado
        ranking.forEach((resultado, indice) => {
            if (indice < 5) {
                const valorLinha = document.createElement('div');
                valorLinha.classList.add('linha');
                valorLinha.innerHTML = `
          <div class="placar">${indice + 1}º</div>
          <div class="placar">${resultado.usuario}</div>
          <div class="placar">${resultado.acertos} pontos</div>
      `;
                corpoTabela.innerHTML += valorLinha.outerHTML;
            }
        });
    }
</script>