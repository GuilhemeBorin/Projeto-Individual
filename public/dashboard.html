<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dash.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="shortcut icon" href="./assets/icones/favIcon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>O Rappa | Dashboard</title>
</head>

<body>
    <main>
        <nav class="main-menu">
            <img class="logo" src="./assets/imgs/ORaioRappa.png" />
            <ul>
                <li class="nav-item active">
                    <b></b>
                    <b></b>
                    <a href="./dashboard.html">
                        <i class="fa fa-house nav-icon"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>

                <li class="nav-item">
                    <b></b>
                    <b></b>
                    <a href="./quiz.html">
                        <i class="fa fa-user nav-icon"></i>
                        <span class="nav-text">Quiz</span>
                    </a>
                </li>

                <li class="nav-item">
                    <b></b>
                    <b></b>
                    <a href="./formulario.html">
                        <i class="fa fa-calendar-check nav-icon"></i>
                        <span class="nav-text">Formulário</span>
                    </a>
                </li>
                <li class="nav-item">
                    <b></b>
                    <b></b>
                    <a href="./index.html">
                        <i class="fa fa-sliders nav-icon"></i>
                        <span class="nav-text">Sair</span>
                    </a>
                </li>
            </ul>
        </nav>

        <section class="content">
            <div class="left-content">
                <div class="left-bottom">
                    <div class="personal-bests">
                        <div class="personal-bests-container">
                            <div class="best-item box-one">
                                <p>Álbum Mais Votado: </p>
                                <b id="div_votado"></b>
                                <span id="b_votos"></span>
                            </div>
                            <div class="best-item box-two">
                                <p>Sua Posição: </p>
                                <b id="b_posicao"></b>
                                <span id="span_pontos"></span>
                            </div>
                            <div class="best-item box-three">
                                <p>Ultima Pontuação: </p>
                                <b id="b_pontuacao""></b>
                            </div>
                        </div>
                    </div>
                </div>

                <div class=" activities">
                                    <h1>Gráficos</h1>
                                    <div class="activity-container">
                                        <div class="box1">
                                            <div class="chart-container">
                                                <canvas id="myChart2" witdh="150" height="175"></canvas>
                                            </div>
                                        </div>

                                        <div class="activity-container">
                                            <div class="box2">
                                                <div class="chart-container2">
                                                    <canvas id="myChart" width: 250px; height: 250px></canvas>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                            </div>
                        </div>

                        <div class="right-content">
                            <div class="tabelaRanking"><!-- Define uma tabela -->
                                <div id="tabelaRanking" class="tabela">

                                    <div class="cabecalho">
                                        <div class="cabecalho-item">Posição</div>
                                        <div class="cabecalho-item">Usuário</div>
                                        <div class="cabecalho-item">Pontuação</div>
                                    </div>
                                    <!--Para barra de rolagem-->
                                    <div class="corpo-scroll">
                                        <div id="corpoTabela" class="corpo"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
        </section>
    </main>
</body>

<script>
    let graficoAlbuns;
    let graficoSexo;
    let ultimaTentativa;
    let ranking = [];


    function buscarUsuario() {

        const idUsuario = sessionStorage.ID_USUARIO;

        if (!idUsuario) {
            console.error('ID de usuário não definido');
            return;
        }

        fetch(`/medidas/posicaoID/${idUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar trazer o resultado");
                }
            })
            .then(function (data) {
                if (data.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }

                // Atualizar o gráfico com os dados recebidos
                atualizarUsuario(data);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
            });
    }

    function atualizarUsuario(tentativaQuiz) {

        const ultimoEnvio = tentativaQuiz[tentativaQuiz.length - 1];

        // Verificar se qtdAcertos está presente no último envio
        if (!ultimoEnvio.qtdAcertos) {
            console.error('qtdAcertos não encontrada no último envio');
            return;
        }

        // Exibe a faixa favorita no HTML
        const ultimaTentativa = ultimoEnvio.qtdAcertos;
        document.getElementById('b_pontuacao').innerHTML = `${ultimaTentativa} Pontos`;
    }

    buscarUsuario();
    setInterval(buscarUsuario, 5000);


    function buscarAlbuns() {
        fetch("/formulario/receberAlbuns", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar trazer o resultado");
                }
            })
            .then(function (data) {
                if (data.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }

                atualizarGraficoAlbuns(data);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
            });
    }

    function atualizarGraficoAlbuns(dados) {
        console.log("Dados recebidos para o gráfico dos albuns:", dados);

        const ctx = document.getElementById('myChart2').getContext('2d');

        if (graficoAlbuns) {
            graficoAlbuns.destroy();
        }
        // Extrair os votos dos dados recebidos e converter para números inteiros
        const votosAlbuns = dados.map(item => item.qtdVotos); // Extraímos apenas os votos
        const nomesAlbuns = ['O Rappa', 'Rappa Mundi', 'Lado B Lado A', 'O Silêncio Q Precede o Esporro', '7 Vezes', 'Nunca Tem Fim...', 'Nao Possui'];
        let qtdVotos = 0;
        let nomeVotado = nomesAlbuns[0];

        // CALCULA QUAL FOI A FAIXA MAIS VOTADA
        for (let i = 0; i < votosAlbuns.length; i++) {
            if (votosAlbuns[i] > qtdVotos) {
                qtdVotos = votosAlbuns[i];
                nomeVotado = nomesAlbuns[i]
            }
        }



        graficoAlbuns = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: nomesAlbuns,
                datasets: [{
                    label: 'Votos dos usuários',
                    data: votosAlbuns,
                    borderColor: 'transparent',
                    backgroundColor: '#1B1A1A',
                }]
            },
            options: {
                animation: false,
                scales: {
                    x: {
                        display: false,
                        beginAtZero: true,
                    },
                    y: {
                        display: false,
                        beginAtZero: true,
                    }
                },
                animation: {
                    duration: 0
                },
            }
        });

        div_votado.innerHTML = nomeVotado;
        b_votos.innerHTML = `${qtdVotos} Votos`;
    }

    buscarAlbuns();
    setInterval(buscarAlbuns, 5000);


    function buscarSexo() {
        fetch("/formulario/receberForm", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar trazer o resultado");
                }
            })
            .then(function (data) {
                if (data.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }
                atualizarGraficoSexo(data)
            })
            .catch(function (erro) {
                console.log(`#ERRO: ${erro}`);
            });
    }



    function atualizarGraficoSexo(dados) {
        const ctx = document.getElementById('myChart').getContext('2d');

        if (graficoSexo) {
            graficoSexo.destroy();
        }

        // Extrai as quantidades do objeto de resultados
        let quantidades = dados.map(item => item.quantidade);

        graficoSexo = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Feminino', 'Masculino'],
                datasets: [{
                    label: 'Gênero',
                    backgroundColor: ['#1B1A1A', '#A7877A'],
                    data: quantidades,
                    borderWidth: 1
                }]
            },
            options: {
                animation: false,
                scales: {
                    y: {
                        display: false,
                        beginAtZero: true,
                    }
                }
            }
        });
    }

    buscarSexo()
    setInterval(buscarSexo, 5000)

    /* Função de ranking*/
    function listarRanking() {
        fetch("/medidas/ranking", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    throw new Error("Houve um erro ao tentar recuperar o ranking");
                }
            })
            .then(function (ranking) {
                if (ranking.length === 0) {
                    console.warn("Nenhum resultado encontrado");
                    return;
                }

                atualizarRanking(ranking);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
            });
    }
    function atualizarRanking(ranking) {

        const nomeUsuario = sessionStorage.NOME_USUARIO
        let posicaoUsuario = 0
        //reordena do maior para o menor (sort() = ornagina os elementos do arraw conforme a função dada)
        ranking.sort((a, b) => b.pontuacao - a.pontuacao);

        const corpoTabela = document.getElementById('corpoTabela');
        corpoTabela.innerHTML = '';

        //forEach() é usado para iterar sobre cada entrada no ranking ordenado
        ranking.forEach((resultado, indice) => {
            if (indice < 5) {
                const valorLinha = document.createElement('div');
                valorLinha.classList.add('linha');
                valorLinha.innerHTML = `
          <div class="placar">${indice + 1}º</div>
          <div class="placar">${resultado.usuario}</div>
          <div class="placar">${resultado.acertos} pontos</div>
      `;
                corpoTabela.innerHTML += valorLinha.outerHTML;
            }
        });

        for (i = 0; i < ranking.length; i++) {
            if (ranking[i].usuario == nomeUsuario) {
                posicaoUsuario = i
                break;
            }
        }

        if(ranking[posicaoUsuario].usuario == nomeUsuario) {
            b_posicao.innerHTML = `${posicaoUsuario + 1}º Lugar`;
            span_pontos.innerHTML = `${ranking[posicaoUsuario].acertos} Pontos`;
        }
    }

    listarRanking();
    setInterval(listarRanking, 5000)
</script>