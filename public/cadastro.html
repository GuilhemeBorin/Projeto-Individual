<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>O Rappa | Cadastro</title>

  <script src="./js/sessao.js"></script>

  <link rel="stylesheet" href="./css/usuario.css" />
  <link rel="shortcut icon" href="./assets/icones/favIcon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.gstatic.com" />
</head>

<body>
  <!-- -------HEADER inicio------- -->
  <div class="header">
    <div class="container">
      <div class="header">
        <nav class="navbar">
          <img class="logoBandaNav" href="./index.html" src="./assets/imgs/ORaioRappa.png" style="width: 95px;">
          <a href="./index.html">INICIAL</a>
          <a href="./index.html #chamaSobre">SOBRE</a>
          <a href="./index.html #Discografia">DISCOGRAFIA</a>
          <a href="./antesQuiz.html">QUIZ</a>
          <a href="./login.html">LOGIN</a>
          <a href="./cadastro.html">CADASTRO</a>
        </nav>
      </div>
    </div>
  </div>

  <div class="espacamento">

  </div>
  <!-- -------HEADER fim------- -->

  <div class="modal1 modal">
    <div class="contentmodal" id="modal_erro">
    </div>
  </div>
  <div class="modal2 modal">
    <div class="contentmodal" id="modal_exito">
      CADASTRO REALIZADO COM SUCESSO!
    </div>
  </div>

  <!-- -------BODY início------- -->
  <div class="alinhaConjunto">
    <div class="conjunto">
      <h2 class="title">BEM VINDO!</h2>
      <div class="nomeIdade">
        <div class="form">
          <input type="text" id="nome_input" class="form__input" autocomplete="off" placeholder=" ">
          <span class="form__span1">NOME</span>
        </div>
        <div class="form_idade">
          <span class="select_idade">IDADE</span>
          <select id="selectIdade">
            <option value="0-12">0-12</option>
            <option value="13-18">13-18</option>
            <option value="19-29">19-29</option>
            <option value="30-40">30-40</option>
            <option value="40+">40+</option>
          </select>
        </div>
      </div>
      <div class="form">
        <input type="text" id="email_input" class="form__input" autocomplete="off" placeholder=" ">
        <span class="form__span">EMAIL</span>
      </div>
      <div class="form">
        <input type="text" id="senha_input" class="form__input" autocomplete="off" placeholder=" ">
        <span class="form__span">SENHA</span>
      </div>
      <div class="form">
        <input type="text" id="confirmacao_senha_input" class="form__input" autocomplete="off" placeholder=" ">
        <span id="confirmarSenha" class="form__span">CONFIRMAÇÃO DE SENHA</span>
      </div>
      <p id="btn"><button onclick="cadastrar()" class="button">CADASTRAR</button></p>
      <div id="div_aguardar" class="loading-div">
        <img src="./assets/aguarde-pink3.gif" id="loading-  gif" />
      </div>
    </div>
  </div>

  <!-- -------BODY fim------- -->
</body>

</html>

<script>

  let caracteresEspeciais = ['@', '.', '*', '#', '$', '&']
  let letrasMaiusculas = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']

  function cadastrar() {
    aguardar();

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    let nomeVar = nome_input.value;
    let emailVar = email_input.value;
    let senhaVar = senha_input.value;
    var idadeVar = selectIdade.value
    let confirmacaoSenhaVar = confirmacao_senha_input.value;
    let arrobaEmail = emailVar.indexOf('@')
    let pontoEmail = emailVar.indexOf('.')
    let validacaoSenha = false



    if (nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == ""
    ) {
      modal_erro.innerHTML = "PREENCHA TODOS OS CAMPOS PARA CONTINUAR!"
      validarSessao(1)
      return false;
    }
    if (pontoEmail == - 1 || arrobaEmail == -1) {
      modal_erro.innerHTML = "O E-MAIL DEVE CONTER UM @ E UM '.'!"
      validarSessao(1)
      return false;
    }
    if (senhaVar.length < 8) {
      modal_erro.innerHTML = "A SENHA PRECISA CONTER NO MÍNIMO OITO CARACTÉRES!"
      validarSessao(1)
      return;
    } else if (senhaVar != confirmacaoSenhaVar) {
      modal_erro.innerHTML = "SENHAS INCOMPATÍVEIS!"
      validarSessao(1)
      return false;
    } else {

      for (let caractereAtual = 0; caractereAtual < caracteresEspeciais.length; caractereAtual++) {
        if (senhaVar.indexOf(caracteresEspeciais[caractereAtual]) !== -1) {
          validacaoSenha = true
          break;
        }
      }
      if (validacaoSenha == false) {
        modal_erro.innerHTML = "A SENHA PRECISA CONTER AO MENOS UM CARACTER ESPECIAL!"
        validarSessao(1)
        return false;
      }

      validacaoSenha = false;
      for (let caractereAtual = 0; caractereAtual < letrasMaiusculas.length; caractereAtual++) {
        if (senhaVar.indexOf(letrasMaiusculas[caractereAtual]) !== -1) {
          validacaoSenha = true
          break;
        }
      }
      if (validacaoSenha == false) {
        modal_erro.innerHTML = "A SENHA PRECISA CONTER UMA LETRA MAIUSCULA!"
        validarSessao(1)
        return false;
      }

      validacaoSenha = false;
      for (let numAtual = 0; numAtual <= 9; numAtual++) {
        if (senhaVar.indexOf(numAtual) !== -1) {
          validacaoSenha = true
          break;
        }
      }
      if (validacaoSenha == false) {
        modal_erro.innerHTML = "A SENHA PRECISA CONTER UM NÚMERO!"
        validarSessao(1)
        return false;
      }

    }
    if (validacaoSenha == true) {
      cadastrarUsuario(nomeVar, emailVar, senhaVar, idadeVar)
    }
  }


  function cadastrarUsuario(nomeVar, emailVar, senhaVar, idadeVar) {
    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        nomeServer: nomeVar,
        emailServer: emailVar,
        senhaServer: senhaVar,
        idadeServer: idadeVar,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          validarSessao(2)

        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    return false;
  }

  function validarSessao(numResposta) {

    // Esconde todos os modais
    const modais = document.querySelectorAll('.modal');
    modais.forEach(modal => modal.style.display = 'none');

    // Exibe o modal correspondente
    const modalSelecionado = document.querySelector(`.modal${numResposta}`);
    if (modalSelecionado) {
      modalSelecionado.style.display = 'block';
    }

    if (numResposta == 1) {
      setTimeout(function () {
        sumirModal()
        finalizarAguardar();
        return false;
      }, 2500)
    }
    else (
      setTimeout(function () {
        modal_exito.innerHTML = "REDIRECIONANDO A TELA DE LOGIN..."
        setTimeout(function () {
          window.location = "./login.html";
        }, 3500);
        finalizarAguardar();
        return false;
      }, 2500)
    )
  }

  function sumirModal() {
    const modais = document.querySelectorAll('.modal');
    modais.forEach(modal => modal.style.display = 'none');
  }

</script>